<!DOCTYPE html>
<html lang="es">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Formulario Doppler</title>

  <!-- Google Tag Manager -->
  <script>(function (w, d, s, l, i) {
      w[l] = w[l] || []; w[l].push({
        'gtm.start':
          new Date().getTime(), event: 'gtm.js'
      }); var f = d.getElementsByTagName(s)[0],
        j = d.createElement(s), dl = l != 'dataLayer' ? '&l=' + l : ''; j.async = true; j.src =
          'https://www.googletagmanager.com/gtm.js?id=' + i + dl; f.parentNode.insertBefore(j, f);
    })(window, document, 'script', 'dataLayer', 'GTM-K5DTMCH');</script>
  <!-- End Google Tag Manager -->

  <!-- Doppler Form Generator -->
  <script src="https://cdn.fromdoppler.com/formgenerator/latest/vendor.js?67493465"></script>
  <link rel="stylesheet" href="https://cdn.fromdoppler.com/formgenerator/latest/styles.css?67493465" />

  <script>
    // Funci√≥n para capturar datos del formulario y enviar a GTM/n8n
    function captureFormData() {

      // Simplemente nos "enganchamos" al evento submit, sin detenerlo.
      const handleSubmit = function (e) {

        const estudiosScoring = {
          "Secundario incompleto": 0,
          "Secundario completo": 10,
          "Terciario incompleto": 10,
          "Terciario completo": 10,
          "Universitario incompleto": 10,
          "Universitario completo": 10,
          "Posgrado/Maestr√≠a": 10,
          "Doctorado/PhD": 10
        }

        const cargoScoring = {
          "Director/Socio/Due√±o": 10,
          "Gerente/Subgerente": 10,
          "Jefe/Coordinador": 5,
          "Analista/Profesional": 4,
          "Emprendedor/Independiente": 7,
          "Estudiante": 0,
          "Otro": 4
        }

        const industriasScoring = {
          "Agro/Alimentos y Bebidas": 10,
          "Automotriz/Autopartes": 10,
          "Banca/Servicios Financieros": 10,
          "Construcci√≥n/Real Estate": 10,
          "Educaci√≥n": 10,
          "Energ√≠a/Miner√≠a/Petr√≥leo & Gas": 10,
          "Gobierno/Sector P√∫blico": 10,
          "Manufactura": 10,
          "Salud/Farmac√©utica/Biotecnolog√≠a": 10,
          "Servicios Profesionales (Consultor√≠a/Legal/Contable)": 9,
          "Tecnolog√≠a/Software/IT": 10,
          "Telecomunicaciones": 10,
          "Transporte/Log√≠stica": 10,
          "Turismo/Hoteler√≠a/Gastronom√≠a": 10,
          "Otro": 7
        }

        const areaScoring = {
          "Administraci√≥n/Estrategia General": 10,
          "Finanzas/Contabilidad": 10,
          "Marketing/Comercializaci√≥n": 10,
          "Operaciones/Supply Chain/Producci√≥n": 10,
          "Tecnolog√≠a/Sistemas/Transformaci√≥n Digital": 10,
          "Recursos Humanos/Desarrollo Organizacional": 10,
          "Legal/Compliance": 10,
          "Salud/Ciencias de la Vida": 10,
          "Educaci√≥n/Acad√©mico/Investigaci√≥n": 10,
          "Emprendimiento/Innovaci√≥n": 9,
          "Otro": 7
        }

        const empleadosScoring = {
          "1‚Äì10": 4,
          "11‚Äì50": 9,
          "51‚Äì200": 10,
          "201‚Äì500": 10,
          "501‚Äì1000": 10,
          "1000+": 10
        }

        const experienciaScoring = {
          "1-4": 6,
          "5-9": 10,
          "10-15": 10,
          "15+": 10
        }

        // Pesos de cada campo (total = 100%)
        const PESOS = {
          cargo: 50,
          estudios: 6,
          industria: 7,
          area: 7,
          empleados: 15,
          experiencia: 15
        };

        // Valor base del programa para calcular Lead Value
        const VALOR_BASE_PROGRAMA = 4800;

        const form = e.target;

        // Capturar todos los campos del formulario
        const formData = {};
        const inputs = form.querySelectorAll('input, select, textarea');

        inputs.forEach(input => {
          const name = input.name || input.id || input.getAttribute('data-field');
          const value = input.type === 'checkbox' ? input.checked : input.value;

          if (name && value) {
            formData[name] = value;
          }
        });

        console.log('formData ->' + JSON.stringify(formData))

        // --- INICIO C√ÅLCULO DE LEAD SCORING Y LEAD VALUE ---
        
        // DEBUG: Mostrar valores capturados de cada campo
        console.log('üîç VALORES CAPTURADOS:');
        console.log('  Estudios (_dp_string219310):', formData['_dp_string219310']);
        console.log('  Cargo (_dp_string18650):', formData['_dp_string18650']);
        console.log('  Industria (_dp_string219311):', formData['_dp_string219311']);
        console.log('  √Årea (_dp_string35228):', formData['_dp_string35228']);
        console.log('  Empleados (_dp_string219712):', formData['_dp_string219712']);
        console.log('  Experiencia (_dp_string219713):', formData['_dp_string219713']);
        
        // Obtener scores individuales (0-10) de cada campo
        const scoreEstudios = estudiosScoring[formData['_dp_string219310']] || 0;
        const scoreCargo = cargoScoring[formData['_dp_string18650']] || 0;
        const scoreIndustria = industriasScoring[formData['_dp_string219311']] || 0;
        const scoreArea = areaScoring[formData['_dp_string35228']] || 0;
        const scoreEmpleados = empleadosScoring[formData['_dp_string219712']] || 0;
        
        // Para Experiencia: si no existe el campo, usar score m√°ximo (10) por defecto
        let scoreExperiencia;
        if (formData['_dp_string219713']) {
          scoreExperiencia = experienciaScoring[formData['_dp_string219713']] || 0;
        } else {
          scoreExperiencia = 10; // Valor por defecto mientras se agrega el campo al formulario
          console.warn('‚ö†Ô∏è Campo de Experiencia no encontrado. Usando score por defecto: 10');
        }

        // REGLA DE DESCALIFICACI√ìN: Si cualquier campo tiene score = 0, el lead se descalifica
        if (scoreEstudios === 0 || scoreCargo === 0 || scoreIndustria === 0 || 
            scoreArea === 0 || scoreEmpleados === 0 || scoreExperiencia === 0) {
          formData['LeadScore'] = 0;
          formData['LeadValue'] = 0;
          
          console.log('========================================');
          console.log('üö´ LEAD DESCALIFICADO');
          console.log('========================================');
          console.log('Scores por campo (0-10):');
          console.log('  - Estudios:', scoreEstudios);
          console.log('  - Cargo:', scoreCargo);
          console.log('  - Industria:', scoreIndustria);
          console.log('  - √Årea:', scoreArea);
          console.log('  - Empleados:', scoreEmpleados);
          console.log('  - Experiencia:', scoreExperiencia);
          console.log('----------------------------------------');
          console.log('RESULTADO FINAL:');
          console.log('  Lead Score: 0%');
          console.log('  Lead Value: $0');
          console.log('========================================');
        } else {
          // Calcular Lead Score (%) aplicando pesos
          const leadScore = 
            (scoreCargo / 10) * PESOS.cargo +
            (scoreEstudios / 10) * PESOS.estudios +
            (scoreIndustria / 10) * PESOS.industria +
            (scoreArea / 10) * PESOS.area +
            (scoreEmpleados / 10) * PESOS.empleados +
            (scoreExperiencia / 10) * PESOS.experiencia;

          // Calcular Lead Value (USD)
          const leadValue = Math.round((VALOR_BASE_PROGRAMA * (leadScore / 100)) * 100) / 100;

          formData['LeadScore'] = leadScore;
          formData['LeadValue'] = leadValue;
          
          console.log('========================================');
          console.log('‚úÖ LEAD CALIFICADO');
          console.log('========================================');
          console.log('Scores individuales (0-10):');
          console.log('  - Estudios:', scoreEstudios);
          console.log('  - Cargo:', scoreCargo);
          console.log('  - Industria:', scoreIndustria);
          console.log('  - √Årea:', scoreArea);
          console.log('  - Empleados:', scoreEmpleados);
          console.log('  - Experiencia:', scoreExperiencia);
          console.log('----------------------------------------');
          console.log('C√°lculo ponderado:');
          console.log('  - Cargo (50%):', ((scoreCargo / 10) * PESOS.cargo).toFixed(2) + '%');
          console.log('  - Estudios (7%):', ((scoreEstudios / 10) * PESOS.estudios).toFixed(2) + '%');
          console.log('  - Industria (7%):', ((scoreIndustria / 10) * PESOS.industria).toFixed(2) + '%');
          console.log('  - √Årea (7%):', ((scoreArea / 10) * PESOS.area).toFixed(2) + '%');
          console.log('  - Empleados (15%):', ((scoreEmpleados / 10) * PESOS.empleados).toFixed(2) + '%');
          console.log('  - Experiencia (15%):', ((scoreExperiencia / 10) * PESOS.experiencia).toFixed(2) + '%');
          console.log('========================================');
          console.log('üìä RESULTADO FINAL:');
          console.log('  Lead Score: ' + leadScore.toFixed(2) + '%');
          console.log('  Lead Value: $' + leadValue);
          console.log('========================================');
        }
        
        // --- FIN C√ÅLCULO DE LEAD SCORING Y LEAD VALUE ---

        // Enviar datos a Google Tag Manager (sincr√≥nico, se ejecuta r√°pido)
        if (window.dataLayer) {
          window.dataLayer.push({
            'event': 'dopplerFormSubmit',
            'formId': 'PavPYqQLC1+k5ArEBTJldw==',
            'formData': formData,
            'timestamp': new Date().toISOString()
          });

          console.log('Datos enviados a GTM:', formData);
        } else {
          console.warn('dataLayer no est√° disponible. Asegurate de tener GTM instalado.');
          console.log('Datos capturados:', formData);
        }

        // --- POST A N8N CON FETCH + KEEPALIVE ---
        // Fire-and-forget. keepalive se asegura de que la petici√≥n se complete
        // incluso si el script de Doppler navega o modifica la p√°gina.
        fetch("https://develop-ceibo.app.n8n.cloud/webhook/form", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(formData),
          keepalive: true
        }).catch(err => console.error("Error enviando a n8n:", err));

        // No hacemos nada m√°s. Dejamos que el evento de submit contin√∫e
        // su flujo normal para que el script de Doppler haga su trabajo.
      };


      // Esperar a que el formulario de Doppler se cargue
      const checkFormInterval = setInterval(() => {
        const form = document.querySelector('form[data-dp-form], form');

        if (form) {
          clearInterval(checkFormInterval);

          // Interceptar el evento submit y usar la funci√≥n nombrada
          form.addEventListener('submit', handleSubmit);

          console.log('Listener de formulario configurado correctamente');
        }
      }, 500); // Chequear cada 500ms hasta que el form est√© disponible

      // Timeout de seguridad (detener despu√©s de 10 segundos)
      setTimeout(() => {
        clearInterval(checkFormInterval);
      }, 10000);
    }


    // Ejecutar cuando el DOM est√© listo
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', captureFormData);
    } else {
      captureFormData();
    }
  </script>
</head>

<body>
  <h1>Formulario de Suscripci√≥n</h1>

  <!-- M√©todo 1: Formulario embebido con script -->
  <div data-dp-form="PavPYqQLC1%2bk5ArEBTJldw%3d%3d"></div>

  <!-- M√©todo 2: iframe (comentado por defecto, descoment√° si prefer√≠s usar el iframe) -->
  <!--
    <iframe id='doppler_subscription' 
            src='https://app2.fromdoppler.com/Lists/FormProcessing/PublishedForm?IdForm=PavPYqQLC1%2bk5ArEBTJldw%3d%3d' 
            height='335' 
            width='375' 
            scrolling='yes' 
            frameborder='no' 
            style='overflow:scroll'>
    </iframe>
    -->
</body>

</html>