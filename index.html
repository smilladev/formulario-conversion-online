<!DOCTYPE html>
<html lang="es">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Formulario Doppler</title>

  <!-- Google Tag Manager -->
  <script>(function (w, d, s, l, i) {
      w[l] = w[l] || []; w[l].push({
        'gtm.start':
          new Date().getTime(), event: 'gtm.js'
      }); var f = d.getElementsByTagName(s)[0],
        j = d.createElement(s), dl = l != 'dataLayer' ? '&l=' + l : ''; j.async = true; j.src =
          'https://www.googletagmanager.com/gtm.js?id=' + i + dl; f.parentNode.insertBefore(j, f);
    })(window, document, 'script', 'dataLayer', 'GTM-K5DTMCH');</script>
  <!-- End Google Tag Manager -->

  <!-- Doppler Form Generator -->
  <script src="https://cdn.fromdoppler.com/formgenerator/latest/vendor.js?67493465"></script>
  <link rel="stylesheet" href="https://cdn.fromdoppler.com/formgenerator/latest/styles.css?67493465" />

  <script>
    // Función para capturar datos del formulario y enviar a GTM/n8n
    function captureFormData() {

      // Simplemente nos "enganchamos" al evento submit, sin detenerlo.
      const handleSubmit = function (e) {

        const estudiosScoring = {
          "Secundario incompleto": 0,
          "Secundario completo": 10,
          "Terciario incompleto": 10,
          "Terciario completo": 10,
          "Universitario incompleto": 10,
          "Universitario completo": 10,
          "Posgrado/Maestría": 10,
          "Doctorado/PhD": 10
        }

        const cargoScoring = {
          "Director/Socio/Dueño": 10,
          "Gerente/Subgerente": 10,
          "Jefe/Coordinador": 5,
          "Analista/Profesional": 4,
          "Emprendedor/Independiente": 7,
          "Estudiante": 0,
          "Otro": 4
        }

        const industriasScoring = {
          "Agro/Alimentos y Bebidas": 10,
          "Automotriz/Autopartes": 10,
          "Banca/Servicios Financieros": 10,
          "Construcción/Real Estate": 10,
          "Educación": 10,
          "Energía/Minería/Petróleo & Gas": 10,
          "Gobierno/Sector Público": 10,
          "Manufactura": 10,
          "Salud/Farmacéutica/Biotecnología": 10,
          "Servicios Profesionales (Consultoría/Legal/Contable)": 9,
          "Tecnología/Software/IT": 10,
          "Telecomunicaciones": 10,
          "Transporte/Logística": 10,
          "Turismo/Hotelería/Gastronomía": 10,
          "Otro": 4
        }

        const areaScoring = {
          "Administración/Estrategia General": 10,
          "Finanzas/Contabilidad": 10,
          "Marketing/Comercialización": 10,
          "Operaciones/Supply Chain/Producción": 10,
          "Tecnología/Sistemas/Transformación Digital": 10,
          "Recursos Humanos/Desarrollo Organizacional": 10,
          "Legal/Compliance": 10,
          "Salud/Ciencias de la Vida": 10,
          "Educación/Académico/Investigación": 10,
          "Emprendimiento/Innovación": 9,
          "Otro": 4
        }

        const empleadosScoring = {
          "1–10": 4,
          "11–50": 9,
          "51–200": 10,
          "201–500": 10,
          "501–1000": 10,
          "1000+": 10
        }



        const form = e.target;

        // Capturar todos los campos del formulario
        const formData = {};
        const inputs = form.querySelectorAll('input, select, textarea');

        inputs.forEach(input => {
          const name = input.name || input.id || input.getAttribute('data-field');
          const value = input.type === 'checkbox' ? input.checked : input.value;

          if (name && value) {
            formData[name] = value;
          }
        });

        console.log('formData ->' + JSON.stringify(formData))

        // --- INICIO CÁLCULO DE LEAD SCORING ---
        let leadScoring = 0;

        // Mapeo de los campos del formulario a los objetos de scoring
        // Estos nombres de campo (_dp_...) provienen de la configuración del formulario de Doppler
        const scoringMap = {
          '_dp_string219310': estudiosScoring,  // Estudios
          '_dp_string18650': cargoScoring,     // Cargo
          '_dp_string219311': industriasScoring, // Industria
          '_dp_string35228': areaScoring,      // Área
          '_dp_string219712': empleadosScoring  // Empleados
        };

        // Itera sobre el mapa de scoring y suma los puntos
        for (const fieldName in scoringMap) {
          const value = formData[fieldName];
          const scoringObject = scoringMap[fieldName];

          // Si el campo tiene un valor y ese valor existe en su tabla de scoring, suma los puntos.
          if (value && scoringObject && scoringObject[value] !== undefined) {
            leadScoring += scoringObject[value];
          }
        }

        // Agregar LeadScoring al formData

        // Validaciones adicionales que anulan el scoring si se cumplen
        const estudiosValue = formData['_dp_string219310'];
        const cargoValue = formData['_dp_string18650'];

        if (estudiosValue === "Secundario incompleto" || cargoValue === "Estudiante") {
          leadScoring = 0;
        }

        formData['LeadScoring'] = leadScoring;
        // --- FIN CÁLCULO DE LEAD SCORING ---
        console.log('Lead Scoring calculado:', leadScoring);

        // Enviar datos a Google Tag Manager (sincrónico, se ejecuta rápido)
        /*  if (window.dataLayer) {
           window.dataLayer.push({
             'event': 'dopplerFormSubmit',
             'formId': 'PavPYqQLC1+k5ArEBTJldw==',
             'formData': formData,
             'timestamp': new Date().toISOString()
           });
 
           console.log('Datos enviados a GTM:', formData);
         } else {
           console.warn('dataLayer no está disponible. Asegurate de tener GTM instalado.');
           console.log('Datos capturados:', formData);
         } */

        // --- POST A N8N CON FETCH + KEEPALIVE ---
        // Fire-and-forget. keepalive se asegura de que la petición se complete
        // incluso si el script de Doppler navega o modifica la página.
        fetch("https://develop-ceibo.app.n8n.cloud/webhook/form", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(formData),
          keepalive: true
        }).catch(err => console.error("Error enviando a n8n:", err));

        // No hacemos nada más. Dejamos que el evento de submit continúe
        // su flujo normal para que el script de Doppler haga su trabajo.
      };


      // Esperar a que el formulario de Doppler se cargue
      const checkFormInterval = setInterval(() => {
        const form = document.querySelector('form[data-dp-form], form');

        if (form) {
          clearInterval(checkFormInterval);

          // Interceptar el evento submit y usar la función nombrada
          form.addEventListener('submit', handleSubmit);

          console.log('Listener de formulario configurado correctamente');
        }
      }, 500); // Chequear cada 500ms hasta que el form esté disponible

      // Timeout de seguridad (detener después de 10 segundos)
      setTimeout(() => {
        clearInterval(checkFormInterval);
      }, 10000);
    }


    // Ejecutar cuando el DOM esté listo
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', captureFormData);
    } else {
      captureFormData();
    }
  </script>
</head>

<body>
  <h1>Formulario de Suscripción</h1>

  <!-- Método 1: Formulario embebido con script -->
  <div data-dp-form="PavPYqQLC1%2bk5ArEBTJldw%3d%3d"></div>

  <!-- Método 2: iframe (comentado por defecto, descomentá si preferís usar el iframe) -->
  <!--
    <iframe id='doppler_subscription' 
            src='https://app2.fromdoppler.com/Lists/FormProcessing/PublishedForm?IdForm=PavPYqQLC1%2bk5ArEBTJldw%3d%3d' 
            height='335' 
            width='375' 
            scrolling='yes' 
            frameborder='no' 
            style='overflow:scroll'>
    </iframe>
    -->
</body>

</html>